name: IBM Cloud — Deploy HBF API

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options: [production, staging]

env:
  IBM_REGION: us-south
  IBM_RESOURCE_GROUP: HBF Resource Group
  REGISTRY_NAMESPACE: hbf-crm
  IMAGE_NAME: hbf-crm
  CE_PROJECT: Halo Business Finance
  CE_APP_NAME: hbf-crm
  REGISTRY_PRIVATE: private.us.icr.io
  REGISTRY_PUBLIC: us.icr.io

jobs:
  # ── Security Scan ──────────────────────────────────────────────────────────
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run npm audit (production dependencies only)
        run: npm audit --audit-level=critical --omit=dev

      - name: Install Trivy
        run: curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.69.1

      - name: Trivy vulnerability scan
        run: |
          trivy fs . \
            --exit-code 0 \
            --severity HIGH,CRITICAL \
            --ignorefile .trivyignore \
            --scanners vuln

  # ── Build & Push Image ─────────────────────────────────────────────────────
  build:
    name: Build & Push to IBM Container Registry
    runs-on: ubuntu-latest
    needs: security
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud plugin install container-registry -f

      - name: IBM Cloud login
        run: |
          ibmcloud login --apikey "${{ secrets.IBM_CLOUD_API_KEY }}" \
            -r "${{ env.IBM_REGION }}" \
            -g "${{ env.IBM_RESOURCE_GROUP }}" -q

      - name: Docker login to IBM CR
        run: ibmcloud cr login --client docker

      - name: Build Docker image
        run: |
          docker build \
            --platform linux/amd64 \
            -f Dockerfile \
            -t "${{ env.REGISTRY_PUBLIC }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}" \
            -t "${{ env.REGISTRY_PUBLIC }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:main" \
            .

      - name: Push to IBM Container Registry
        run: |
          docker push "${{ env.REGISTRY_PUBLIC }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}"
          docker push "${{ env.REGISTRY_PUBLIC }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:main"

      - name: IBM Container Registry vulnerability scan
        run: |
          ibmcloud cr va "${{ env.REGISTRY_PUBLIC }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}" || true

  # ── Deploy API to Code Engine ─────────────────────────────────────────────
  deploy-api:
    name: Deploy API to IBM Code Engine
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud plugin install code-engine -f

      - name: IBM Cloud login
        run: |
          ibmcloud login --apikey "${{ secrets.IBM_CLOUD_API_KEY }}" \
            -r "${{ env.IBM_REGION }}" \
            -g "${{ env.IBM_RESOURCE_GROUP }}" -q

      - name: Select Code Engine project
        run: ibmcloud ce project select --name "${{ env.CE_PROJECT }}"

      - name: Deploy to Code Engine
        run: |
          PRIVATE_IMAGE="${{ env.REGISTRY_PRIVATE }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_tag }}"
          ibmcloud ce application update \
            --name "${{ env.CE_APP_NAME }}" \
            --image "${PRIVATE_IMAGE}" \
            --registry-secret hbf-crm \
            --env DATABASE_URL="${{ secrets.IBM_DB_CONNECTION_STRING }}" \
            --env NODE_ENV=production \
            --min-scale 1 --max-scale 10 \
            --cpu 0.5 --memory 1G || \
          ibmcloud ce application create \
            --name "${{ env.CE_APP_NAME }}" \
            --image "${PRIVATE_IMAGE}" \
            --registry-secret hbf-crm \
            --port 8080 \
            --env DATABASE_URL="${{ secrets.IBM_DB_CONNECTION_STRING }}" \
            --env NODE_ENV=production \
            --min-scale 1 --max-scale 10 \
            --cpu 0.5 --memory 1G

      - name: Wait for revision to become ready
        run: |
          echo "⏳ Waiting for Code Engine revision to become ready..."
          for i in $(seq 1 20); do
            READY=$(ibmcloud ce application get --name "${{ env.CE_APP_NAME }}" --output json \
              | python3 -c "import sys,json; a=json.load(sys.stdin); conds=a.get('status',{}).get('conditions',[]); r=[c for c in conds if c.get('type')=='Ready']; print(r[0].get('status','False') if r else 'False')" 2>/dev/null || echo "False")
            echo "  Attempt ${i}/20 — Ready: ${READY}"
            [ "${READY}" = "True" ] && break
            sleep 15
          done

      - name: Verify deployment
        run: |
          URL=$(ibmcloud ce application get --name "${{ env.CE_APP_NAME }}" --output json \
            | python3 -c "import sys,json; a=json.load(sys.stdin); print(a.get('status',{}).get('url',''))" 2>/dev/null || echo "")
          echo "Deployed to: ${URL}"
          [ -n "${URL}" ] && curl -sf "${URL}/health" && echo "✅ Health check passed" || echo "⚠️  Health check skipped (URL not yet available)"
